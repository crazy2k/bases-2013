%\section{Modelo F\'isico - Funcionalidades Implementadas}
\section{Modelo F\'isico}

\noindent
Para el modelo f\'isico elegimos utlizar my-sql en un servidor online,
que usa php.

\section{Modelo F\'isico - Funcionalidades Pedidas}

%\subsection{Restricciones}

%\subsection{Funcionalidades Implementadas}
\subsection{Stored Procedures}

\noindent
Para ejecutar el c\'odigo de los stored procedures se realiza lo 
siguiente

\vspace*{0.5cm}
\noindent
\textbf{Ejercicio 1} call ejercicio\_1 ()\\
\textbf{Ejercicio 2} call ejercicio\_2()\\
\textbf{Ejercicio 3} call arbitros\_asignados\_para\_partido 
(id\_partido) donde id\_partido es un partido fijo para el que se 
quieren obtener los arbitros asignados.

\newpage
\subsubsection{Nombres de los pa\'ises cuyos equipos utilizaron a todos 
sus \newline jugadores en alg\'un partido como titulares.}

\begin{verbatim}
delimiter $$
create procedure ejercicio_1()
begin
select p.nombre 
from Pais p 
where not exists
(
    select * 
    from Jugador j
    
    inner join Integrante inte 
    on inte.nro_pasaporte = j.nro_pasaporte
    
    inner join Equipo_Nacional equ on 
    equ.id_equipo = inte.id_equipo
    where not exists
    (                     
        select * 
        from Partido par                                            
        
        inner join Juego jueg 
        on par.id_partido = jueg.id_partido 
        where   j.nro_pasaporte = jueg.nro_pasaporte_jugador 
                and jueg.titular = 1
    ) 
    and equ.id_pais_representado = p.id_pais
)
end;
$$
delimiter ;
\end{verbatim}

\vspace*{0.5cm}
\noindent
Se realizaron dos not exists anidados para obtener todos los nombres 
de los pa\'ises que cumpl\'ian la condici\'on deseada.


\newpage
\subsubsection{Nombres de los jugadores, la cantidad de partidos en que 
participaron y los promedios de puntos, asistencias y rebotes; 
ordenado por cantidad de partidos.}

\begin{verbatim}
delimiter $$
create procedure ejercicio_2()
begin
select  inte.nombre, 
        count(jueg.id_partido) as cant_partidos,
        avg(puntos) as puntos,
        avg(asistencias) as asistencias,
        avg(rebotes) as rebotes 
from Integrante inte

inner join Juego jueg 
on inte.nro_pasaporte = jueg.nro_pasaporte_jugador

group by inte.nro_pasaporte order by cant_partidos
end;
$$
delimiter ;
\end{verbatim}

\newpage
\subsubsection{Posibles \'arbitros para un partido dado.}
                                                          
%\small
\begin{verbatim}
delimiter $$
create procedure arbitros_asignados_para_partido(in id_partido_in int(11))
begin
declare fecha_partido_in date;
declare id_equipo_1 int(11);
declare id_equipo_2 int(11);
declare cant_veces_digirio_1 int(11);
declare cant_veces_dirigio_2 int(11);

select fecha 
into @fecha_partido 
from Partido 
where 	id_partido = id_partido_in;

select id_equipo 
into @id_equipo_1 
from Juega 
where 	id_partido = id_partido_in 
order by id_equipo desc limit 1;

select id_equipo 
into @id_equipo_2 
from Juega 
where id_partido = id_partido_in 
order by id_equipo asc limit 1;

select arbitroresult.id_arbitro 
into id_arbitro_out 
from Arbitro arbitroresult 
where arbitroresult.id_arbitro 

not in
(
    #-- Condiciones que los ids de arbitro no deberian cumplir
    select arbnoquiero.id_arbitro 
    from Arbitro arbnoquiero     
    #-- existe un partido con la misma fecha a la que este 
    #-- asignado el arbitro que no se quiere devolver
\end{verbatim}    

\newpage
\begin{verbatim}
    where exists
    (
	    select * 
	    from Partido par
	
	    inner join Arbitra ar 
	    on ar.id_partido 
	    where  par.fecha = fecha_partido_in 
	    and ar.id_arbitro = arbnoquiero.id_arbitro
    )    
    #-- el arbitro que no se quiere dirigio una sola vez 
    #-- a cada equipo, con resultados opuestos
    or	
    (
    
    #-- dirigio solo una vez el equipo 1
    (
        select count(*) 
        from Arbitra arbi1 
        where arbi1.id_arbitro = arbnoquiero.id_arbitro 
        and arbi1.id_partido 
        in 
        (select jueg.id_partido 
        from Juega jueg 
        where jueg.id_equipo = id_equipo_1) = 1
    )
    
    #-- dirigio solo una vez al equipo 2
    and 
    (
        select count(*) 
        from Arbitra arbi2 
        where arbi2.id_arbitro = arbnoquiero.id_arbitro 
        and arbi2.id_partido 
        in 
        (select jueg.id_partido 
        from Juega jueg 
        where jueg.id_equipo = id_equipo_2) = 1
    )
\end{verbatim}    

\newpage
\begin{verbatim}    
    #-- los resultados fueron opuestos
    and 
    (
        #-- gano equipo 2 y perdio equipo 1
        
        (select part1.id_equipo_ganador 
        from Partido part1 
        #-- el ganador del partido en que estuvo 2, fue 2
        where part1.id_partido 
        in 
        (select arbi3.id_partido 
        from Arbitra arbi3 
        where arbi3.id_arbitro = arbnoquiero.id_arbitro 
        and arbi3.id_partido 
        in 
        (select jueg.id_partido 
        from Juega jueg 
        where jueg.id_equipo = id_equipo_2)) = id_equipo_2
        )
        
        and 
        (
            select part2.id_equipo_ganador 
            from Partido part2 
            #-- el ganador del partido en que estuvo 1, no fue 1
            where part2.id_partido 
            in 
            (select arbi4.id_partido 
            from Arbitra arbi4 
            where arbi4.id_arbitro = arbnoquiero.id_arbitro 
            and arbi4.id_partido 
            in 
            (select jueg.id_partido 
            from Juega jueg 
            where jueg.id_equipo = id_equipo_1)) <> id_equipo_1
        )

\end{verbatim}    

\newpage
\begin{verbatim}  
        #-- gano 1 y perdio 2
        or 
        (
            (select part3.id_equipo_ganador 
            from Partido part3 
            #-- el ganador del partido en que estuvo 1, fue 1
            where part3.id_partido 
            in 
            (select arbi5.id_partido 
            from Arbitra arbi5 
            where arbi5.id_arbitro = arbnoquiero.id_arbitro 
            and arbi5.id_partido 
            in 
            (select jueg.id_partido 
            from Juega jueg 
            where jueg.id_equipo = id_equipo_1)) = id_equipo_1
            )
        
            and
            (
                select part4.id_equipo_ganador 
                from Partido part4 
                #-- el ganador del partido en que estuvo 2, no fue 2 
                where part4.id_partido 
                in 
                (select arbi6.id_partido 
                from Arbitra arbi6 
                where arbi6.id_arbitro = arbnoquiero.id_arbitro 
                and arbi6.id_partido in 
                (select jueg.id_partido 
                from Juega jueg 
                where jueg.id_equipo = id_equipo_2)) <> id_equipo_2
            )
        )
    )
    )
\end{verbatim}    

\newpage
\begin{verbatim}    
	#-- Dirigi칩 a alguno de los equipos 2 o m치s veces, y en todos 
	#-- los partidos el equipo obtuvo el mismo resultado 
	#-- (gan칩 o perdi칩, no hay empate)
	or
    (
        #-- Dirigio mas de una vez al equipo 1
        (
            (select count(*) 
            from Arbitra arbi8 
            where arbi8.id_arbitro = arbnoquiero.id_arbitro 
            and arbi8.id_partido 
            in 
            (select jueg8.id_partido 
            from Juega jueg8 
            where jueg8.id_equipo = id_equipo_1) >= 2
            )
        
        #-- En todos los partidos, el equipo1 obtuvo el mismo resultado
        and 
        (
            (
                #-- El equipo 1 perdio todos los partidos 
                exists
                (select 1 
                from Partido parti 
                where parti.id_partido 
                #-- 1 para el exists si perdio todos
                in
                (select arbi9.id_partido 
                from Arbitra arbi9 
                where arbi9.id_arbitro = arbnoquiero.id_arbitro 
                and arbi9.id_partido in 
                (select jueg9.id_partido 
                from Juega jueg9 
                where jueg9.id_equipo = id_equipo_1)
                )
\end{verbatim}    

\newpage
\begin{verbatim}            
                #-- No existe un partido de todos los que dirigio el 
                #-- arbitro en los que el equipo ganador haya sido el eq 1 
                and not exists 
                (select * 
                from Partido parti2 
                where parti2.id_partido = parti.id_partido 
                and parti2.id_equipo_ganador <> id_equipo_1)
                )
            )
            
            or
            (
                #-- El equipo 1 gano todos los partidos 
                #-- (Lo mismo pero con id_equipo_ganador = id_equipo_1)
                exists
                (select 1 
                from Partido parti3 
                where parti3.id_partido 
                #-- 1 para el exists si perdio todos
                in
                (
                select arbi9.id_partido 
                from Arbitra arbi9 
                where arbi9.id_arbitro = arbnoquiero.id_arbitro 
                and arbi9.id_partido 
                in 
                (select jueg9.id_partido 
                from Juega jueg9 
                where jueg9.id_equipo = id_equipo_1)
                )
                
                #-- No existe un partido de todos los que dirigio el 
                #-- arbitro en los que el equipo ganador haya sido el eq 1
                and not exists 
                (select * 
                from Partido parti4 
                where parti4.id_partido = parti3.id_partido 
                and parti4.id_equipo_ganador= id_equipo_1)
                )
            )
        )
        )
\end{verbatim}    

\newpage
\begin{verbatim}
        or 
        (
            #-- Dirigio mas de una vez al equipo 2
            (select count(*) 
            from Arbitra arbi 
            where arbi.id_arbitro = arbnoquiero.id_arbitro 
            and arbi.id_partido 
            in 
            (select jueg.id_partido 
            from Juega jueg 
            where jueg.id_equipo = id_equipo_2) >= 2)
            
            #-- En todos los partidos, el equipo 2 obtuvo 
            #-- el mismo resultado
            and 
            (
                #-- El equipo 2 perdio todos los partidos
                (
                exists(
                select 1 
                from Partido parti5 
                where parti5.id_partido 
                #-- 1 para el exists si perdio todos
                in
                (select arbi10.id_partido 
                from Arbitra arbi10 
                where arbi10.id_arbitro = arbnoquiero.id_arbitro 
                and arbi10.id_partido 
                in 
                (select jueg10.id_partido 
                from Juega jueg10 
                where jueg10.id_equipo = id_equipo_2)
                )
                
                #-- No existe un partido de todos los que dirigio el 
                #-- arbitro en los que el equipo ganador haya sido el eq 2
                and not exists 
                (select * 
                from Partido parti6 
                where parti6.id_partido = parti5.id_partido 
                and parti6.id_equipo_ganador <> id_equipo_2)
                )
                )
                
                #-- El equipo 2 gano todos los partidos 
                #-- (Lo mismo pero con id_equipo_ganador = id_equipo_1)
                or
                (exists(
                select 1 
                from Partido parti7 
                where parti7.id_partido 
                #1 para el exists si perdio todos
                in
                (select arbi11.id_partido 
                from Arbitra arbi11 
                where arbi11.id_arbitro = arbnoquiero.id_arbitro 
                and arbi11.id_partido 
                in 
                (select jueg11.id_partido 
                from Juega jueg11 
                where jueg11.id_equipo = id_equipo_2)
                )
                
                #-- No existe un partido de todos los que dirigio el 
                #-- arbitro en los que el equipo ganador haya sido el eq 2
                and not exists 
                (select * 
                from Partido parti8 
                where parti8.id_partido = parti7.id_partido 
                and parti8.id_equipo_ganador= id_equipo_2)
                )
                )
            )
        )
    )                                
);
end;
$$
delimiter ;
\end{verbatim}

\newpage
\subsection{Triggers - Restricciones}

\subsubsection{No se puede asignar un \'arbitro en un partido que sea 
del mismo pa\'is que alguno de los equipos que participan.}

\begin{verbatim}
delimiter $$
create trigger check_nacionalidad 
before insert 
on Arbitra
for each row begin
    if
    (
        exists
        (
            select 1 from Partido p
            
            inner join Juega j 
            on p.id_partido = j.id_partido 
            
            inner join Equipo_Nacional eq_local 
            on eq_local.id_equipo = j.id_equipo
            
            inner join Equipo_Nacional eq_visit 
            on eq_visit.id_equipo = j.id_equipo
            where
                    p.id_partido = new.id_partido
                    and eq_local.id_pais_representado = 
                                (select id_pais_nacionalidad 
                                from Arbitro 
                                where id_arbitro = new.id_arbitro)
                    and eq_visit.id_pais_representado = 
                                (select id_pais_nacionalidad 
                                from Arbitro 
                                where id_arbitro = new.id_arbitro) 
        )
    )
    then
        set new.id_partido = NULL;
    end if;
end;
$$
delimiter ;
\end{verbatim}
